<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COUNTER:MERGE — Urban Fantasy Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Noto+Sans+KR:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ==== CounterSide Urban Fantasy Theme ==== */
body {
  font-family: "Noto Sans KR", "Orbitron", sans-serif;
  background: linear-gradient(to bottom, rgba(10,10,15,0.95), rgba(15,10,20,0.95)), 
              url('https://images.unsplash.com/photo-1606787366850-de6330128bfc?auto=format&fit=crop&w=1920&q=80') center/cover no-repeat fixed;
  color: #f3f3f3;
  margin: 0;
  padding: 25px;
  overflow-x: hidden;
}

h1 {
  text-align: center;
  font-family: "Orbitron";
  letter-spacing: 2px;
  color: #ff3c41;
  text-shadow: 0 0 10px rgba(255,60,70,0.6);
}

.container {
  max-width: 950px;
  margin: auto;
  background: rgba(25,25,35,0.75);
  border: 1px solid rgba(255,60,60,0.25);
  border-radius: 12px;
  box-shadow: 0 0 25px rgba(255,60,60,0.08);
  padding: 20px;
  backdrop-filter: blur(8px);
}

.option-box {
  border: 1px solid rgba(255,60,60,0.2);
  border-left: 4px solid #ff3c41;
  background: rgba(15,15,25,0.6);
  padding: 15px 20px;
  border-radius: 8px;
  margin-bottom: 15px;
  box-shadow: 0 0 12px rgba(255,60,60,0.05);
}

button, input, select {
  background: rgba(40,40,55,0.9);
  color: #f3f3f3;
  border: 1px solid rgba(255,60,60,0.3);
  border-radius: 6px;
  padding: 6px 10px;
  margin: 3px;
  transition: 0.2s;
}
button:hover {
  background: rgba(255,60,60,0.2);
  border-color: #ff3c41;
  box-shadow: 0 0 8px rgba(255,60,60,0.4);
  cursor: pointer;
}
button.active {
  border-color: #ff3c41;
  color: #ff3c41;
}
#modeBtn {
  float: right;
  color: #ff3c41;
  border-color: #ff3c41;
  background: rgba(50,10,10,0.5);
}
#modeBtn:hover {
  background: rgba(80,20,20,0.6);
  color: #ff6f73;
}

.thumb-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.thumb {
  position: relative;
  width: 120px; height: 90px;
  border: 1px solid rgba(255,60,60,0.3);
  border-radius: 5px;
  overflow: hidden;
  background: rgba(20,20,30,0.7);
}
.thumb img {
  width: 100%; height: 100%;
  object-fit: cover;
}
.thumb .index-label {
  position: absolute; top: 3px; left: 3px;
  background: rgba(255,60,60,0.6);
  font-size: 11px;
  padding: 1px 3px;
  border-radius: 2px;
  color: #fff;
}
.thumb .btns {
  position: absolute; right: 2px; bottom: 2px;
  display: flex; gap: 2px;
}
.thumb button.small {
  padding: 2px 4px; font-size: 10px;
  background: rgba(40,40,50,0.8);
  border: 1px solid rgba(255,60,60,0.3);
}
.thumb button.small:hover {
  background: rgba(255,60,60,0.2);
  border-color: #ff3c41;
}

canvas {
  max-width: 100%;
  border: 1px solid rgba(255,60,60,0.25);
  border-radius: 8px;
  margin-top: 10px;
  box-shadow: 0 0 12px rgba(255,60,60,0.1);
}

#timer {
  text-align: center;
  color: #aaa;
  margin-top: 5px;
  font-family: "Orbitron";
}

/* ==== Loading Overlay ==== */
#loadingOverlay {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.85);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 999;
  overflow: hidden;
}
#loadingOverlay .loading-text {
  font-family: "Orbitron";
  color: #ff3c41;
  font-size: 20px;
  letter-spacing: 1px;
  text-shadow: 0 0 10px #ff3c41;
  animation: glow 1.5s infinite alternate;
}
@keyframes glow {
  from { text-shadow: 0 0 5px #ff3c41; opacity: 0.8; }
  to { text-shadow: 0 0 20px #ff6f73; opacity: 1; }
}
#loadingOverlay .scanline {
  position: absolute;
  top: -100%;
  left: 0;
  width: 100%;
  height: 30px;
  background: linear-gradient(to bottom, transparent, rgba(255,60,60,0.2), transparent);
  animation: scan 2s linear infinite;
}
@keyframes scan {
  0% { top: -30%; }
  100% { top: 130%; }
}
</style>
</head>
<body>
<h1>COUNTER:MERGE — URBAN FANTASY SYSTEM</h1>
<div class="container">

  <button id="modeBtn">현재: 세로모드 🔽</button>

  <div class="option-box">
    <h3>① 이미지 업로드 및 순서 설정</h3>
    <input type="file" id="fileInput" multiple accept="image/*"><br>
    <small>↻ 회전 / ❌ 삭제 / 드래그로 순서 변경 가능</small><br>
    <button id="sortName">이름순</button>
    <button id="sortNameReverse">역순</button>
    <div id="thumbContainer" class="thumb-list"></div>
  </div>

  <div class="option-box">
    <h3>② 옵션 설정</h3>
    <div>
      <label>가로 크기:</label>
      <button class="widthBtn" data-width="auto">자동</button>
      <button class="widthBtn" data-width="1280">1280</button>
      <button class="widthBtn" data-width="1920">1920</button>
      <input type="number" id="customWidth" placeholder="직접입력(px)" style="width:110px">
    </div>
    <div>
      <label>비율 조정:</label>
      <label><input type="radio" name="scaleMode" value="keep" checked> 비율 유지</label>
      <label><input type="radio" name="scaleMode" value="stretch"> 폭 강제</label>
    </div>
    <div>
      <label>간격(px):</label>
      <input type="number" id="gapInput" value="0" min="0" style="width:70px">
    </div>
    <div>
      <label>출력:</label>
      <label><input type="radio" name="format" value="image/jpeg" checked> JPEG</label>
      <label><input type="radio" name="format" value="image/png"> PNG</label>
    </div>
  </div>

  <div class="option-box">
    <h3>③ 결과</h3>
    <button id="mergeBtn">이미지 합치기</button>
    <button id="downloadBtn" disabled>다운로드</button>
    <div id="timer"></div>
    <canvas id="resultCanvas"></canvas>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay">
  <div class="scanline"></div>
  <div class="loading-text">가은이가 열심히 만들고 있어요...</div>
</div>

<script>
const fileInput=document.getElementById('fileInput');
const thumbContainer=document.getElementById('thumbContainer');
const mergeBtn=document.getElementById('mergeBtn');
const downloadBtn=document.getElementById('downloadBtn');
const canvas=document.getElementById('resultCanvas');
const ctx=canvas.getContext('2d');
const timerEl=document.getElementById('timer');
const loadingOverlay=document.getElementById('loadingOverlay');
const modeBtn=document.getElementById('modeBtn');
let mode='vertical';
let images=[],selectedWidth='auto';

modeBtn.onclick=()=>{
 mode=(mode==='vertical')?'horizontal':'vertical';
 modeBtn.textContent = mode==='vertical' ? "현재: 세로모드 🔽" : "현재: 가로모드 ▶️";
};

document.querySelectorAll('.widthBtn').forEach(btn=>{
 btn.addEventListener('click',()=>{
 selectedWidth=btn.dataset.width==='auto'?'auto':parseInt(btn.dataset.width);
 document.querySelectorAll('.widthBtn').forEach(b=>b.classList.remove('active'));
 btn.classList.add('active');
 });
});

fileInput.addEventListener('change',()=>{
 const files=Array.from(fileInput.files);
 const totalSizeMB=files.reduce((s,f)=>s+f.size,0)/(1024*1024);
 const limit=300;
 if(totalSizeMB>limit){
   alert(`총 용량 ${totalSizeMB.toFixed(1)}MB / 최대 ${limit}MB까지 가능합니다.`);
   return;
 }
 images=[];
 files.forEach(f=>{
   const r=new FileReader();
   r.onload=e=>{
     images.push({src:e.target.result,name:f.name,rotation:0});
     renderThumbs();
   };
   r.readAsDataURL(f);
 });
});

function renderThumbs(){
 thumbContainer.innerHTML='';
 images.forEach((imgObj,i)=>{
 const div=document.createElement('div');
 div.className='thumb';div.draggable=true;div.dataset.index=i;
 const img=document.createElement('img');
 img.src=imgObj.src;img.style.transform=`rotate(${imgObj.rotation}deg)`;
 const label=document.createElement('div');
 label.className='index-label';label.textContent=i+1;
 const btns=document.createElement('div');btns.className='btns';
 const rot=document.createElement('button');rot.textContent='↻';rot.className='small';
 rot.onclick=()=>{imgObj.rotation=(imgObj.rotation+90)%360;renderThumbs();};
 const del=document.createElement('button');del.textContent='❌';del.className='small';
 del.onclick=()=>{images.splice(i,1);renderThumbs();};
 btns.appendChild(rot);btns.appendChild(del);
 div.appendChild(img);div.appendChild(label);div.appendChild(btns);
 thumbContainer.appendChild(div);
 div.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',i));
 div.addEventListener('dragover',e=>e.preventDefault());
 div.addEventListener('drop',e=>{
   e.preventDefault();
   const from=parseInt(e.dataTransfer.getData('text/plain'));
   const to=i;if(from!==to){const t=images.splice(from,1)[0];images.splice(to,0,t);renderThumbs();}
 });
 });
}

document.getElementById('sortName').onclick=()=>{images.sort((a,b)=>a.name.localeCompare(b.name,'ko'));renderThumbs();};
document.getElementById('sortNameReverse').onclick=()=>{images.sort((a,b)=>b.name.localeCompare(a.name,'ko'));renderThumbs();};

mergeBtn.addEventListener('click',async()=>{
 if(images.length===0)return alert('이미지를 먼저 업로드하세요.');
 loadingOverlay.style.display='flex';
 const start=performance.now();
 const gap=parseInt(document.getElementById('gapInput').value)||0;
 const custom=parseInt(document.getElementById('customWidth').value);
 const scaleMode=document.querySelector('input[name="scaleMode"]:checked').value;
 const format=document.querySelector('input[name="format"]:checked').value;
 const loaded=await Promise.all(images.map(loadImage));
 let canvasWidth=(selectedWidth==='auto')?Math.max(...loaded.map(i=>i.width)):selectedWidth;
 if(custom>0)canvasWidth=custom;
 const scaled=[];
 for(let i=0;i<loaded.length;i++){
   const img=loaded[i];let w=img.width,h=img.height;
   if(scaleMode==='keep'){const s=canvasWidth/w;w*=s;h*=s;}
   else if(scaleMode==='stretch'){w=canvasWidth;}
   scaled.push({img,w,h});
 }
 if(mode==='vertical'){
   canvas.width=canvasWidth;
   canvas.height=scaled.reduce((s,v)=>s+v.h,0)+gap*(scaled.length-1);
 } else {
   canvas.height=Math.max(...scaled.map(s=>s.h));
   canvas.width=scaled.reduce((s,v)=>s+v.w,0)+gap*(scaled.length-1);
 }
 ctx.fillStyle="#fff";ctx.fillRect(0,0,canvas.width,canvas.height);
 let pos=0;
 for(let i=0;i<scaled.length;i++){
   const s=scaled[i];
   if(mode==='vertical'){ctx.drawImage(s.img,0,pos,s.w,s.h);pos+=s.h+gap;}
   else {ctx.drawImage(s.img,pos,0,s.w,s.h);pos+=s.w+gap;}
 }
 const elapsed=((performance.now()-start)/1000).toFixed(2);
 timerEl.textContent=`처리 완료 (${elapsed}초)`;
 loadingOverlay.style.display='none';
 downloadBtn.disabled=false;
 downloadBtn.onclick=()=>{
   const link=document.createElement('a');
   link.download='merged'+(format==='image/png'?'.png':'.jpg');
   link.href=canvas.toDataURL(format,0.95);
   link.click();
 };
});
function loadImage(o){return new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=o.src;});}
</script>
</body>
</html>
