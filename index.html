<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>이미지 이어붙이기</title>

  <!-- Favicon 이모지는 유지 -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧩</text></svg>">

  <style>
  /* ------------------------------------------------------------------
     1) 테마 변수: 네가 준 팔레트/타이포 그대로
  ------------------------------------------------------------------ */
  :root{
    --background-color:#f4f6f9;
    --panel-bg:#ffffff;
    --panel-border:#e0e6ed;
    --text-primary:#2c3e50;
    --text-secondary:#8a95a5;
    --header-bg:#2c3e50;
    --accent-primary:#3498db;
    --accent-primary-dark:#2980b9;
    --accent-secondary:#2ecc71;
    --accent-secondary-dark:#27ae60;
    --input-bg:#ffffff;
    --input-border:#dce1e6;
    --shadow:rgba(44,62,80,.1);
    --inactive-tab-bg:#5f7a95;

    --font-primary:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,'Noto Sans KR',sans-serif;
    --font-secondary:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,'Noto Sans KR',sans-serif;
  }
  body.dark-mode{
    --background-color:#1c2128;
    --panel-bg:#2d333b;
    --panel-border:#444c56;
    --text-primary:#e6edf3;
    --text-secondary:#909dab;
    --header-bg:#2d333b;
    --accent-primary:#58a6ff;
    --accent-primary-dark:#388bfd;
    --accent-secondary:#34d399;
    --accent-secondary-dark:#10b981;
    --input-bg:#22272e;
    --input-border:#444c56;
    --shadow:rgba(0,0,0,.4);
    --inactive-tab-bg:#444c56;
  }

  /* ------------------------------------------------------------------
     2) 베이스 레이아웃 (네 스타일 유지)
  ------------------------------------------------------------------ */
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:var(--font-secondary);
    font-size:16px;
    background:var(--background-color);
    color:var(--text-primary);
    min-height:100vh;
    display:flex; justify-content:center; align-items:flex-start;
    padding:2rem;
    transition:background-color .3s,color .3s;
  }
  .container{width:100%;max-width:1200px;display:flex;flex-direction:column;gap:1.5rem;align-items:center}
  .content-wrapper{width:100%}

  /* ------------------------------------------------------------------
     3) 헤더 (탭 제거) + 토글은 동일 이모지 유지
  ------------------------------------------------------------------ */
  .app-header{
    width:100%;
    background:var(--header-bg);
    color:#fff;
    padding:1.5rem 2rem;
    border-radius:16px;
    text-align:center;
    box-shadow:0 8px 32px var(--shadow);
    position:relative;
    transition:background-color .3s;
  }
  .app-header h1{font-size:1.75rem;font-weight:600;margin-bottom:.5rem}
  .version-info{
    position:absolute; top:1.5rem; right:2rem;
    font-size:.8rem; line-height:1.4; color:rgba(255,255,255,.8);
  }
  body.dark-mode .version-info{color:var(--text-secondary)}
  .theme-toggle{
    position:absolute; top:1.5rem; left:2rem;
    background:var(--inactive-tab-bg);
    border:1px solid transparent; color:#fff;
    padding:.5rem 1rem; border-radius:20px;
    display:flex; align-items:center; gap:.5rem;
    font-weight:600; font-size:.9rem; cursor:pointer; transition:all .2s;
  }
  .theme-toggle:hover{background:var(--accent-primary)}
  .theme-toggle:active{transform:scale(.97)}
  .theme-toggle .sun-icon,.theme-toggle .moon-icon{display:none}
  body:not(.dark-mode) .theme-toggle .moon-icon{display:block}
  body.dark-mode .theme-toggle .sun-icon{display:block}
  body.dark-mode .theme-toggle{
    background:var(--input-bg); color:var(--text-primary); border:1px solid var(--panel-border)
  }
  body.dark-mode .theme-toggle:hover{border-color:var(--accent-primary); color:var(--accent-primary)}

  /* ------------------------------------------------------------------
     4) 패널/폼 기본 (네 스타일 유지)
  ------------------------------------------------------------------ */
  .panel{
    background:var(--panel-bg);
    border:1px solid var(--panel-border);
    border-radius:16px;
    box-shadow:0 8px 32px var(--shadow);
    padding:2rem;
    transition:background-color .3s,border-color .3s;
  }
  .panel-header{
    margin-bottom:1.2rem; border-bottom:2px solid var(--accent-primary);
    padding-bottom:.75rem; display:flex; justify-content:space-between; align-items:center;
  }
  .panel-header h2{font-size:1.25rem;font-weight:700;color:var(--text-primary)}
  .sheet-content{width:100%}
  #editor-sheet{display:flex; gap:2rem; align-items:flex-start}
  .settings-panel{flex:1;min-width:320px;max-width:460px}
  .results-panel{flex:2;min-width:420px}

  .input-group{display:flex;flex-direction:column}
  .input-group label{font-size:.9rem;font-weight:600;color:var(--text-primary);margin-bottom:.5rem}

  .input-wrapper{
    position:relative; display:flex; align-items:center;
    background:var(--input-bg); border:1px solid var(--input-border);
    border-radius:8px; overflow:hidden;
    transition:border-color .2s,box-shadow .2s,background-color .3s;
  }
  .input-wrapper:focus-within{border-color:var(--accent-primary); box-shadow:0 0 0 3px rgba(52,152,219,.2)}
  body.dark-mode .input-wrapper:focus-within{box-shadow:0 0 0 3px rgba(88,166,255,.25)}
  .input-wrapper input,.input-wrapper select{
    width:100%; background:transparent; border:none; padding:.8rem 1rem;
    font-size:1rem; color:var(--text-primary); font-family:var(--font-secondary)
  }
  .small{font-size:.85rem;color:var(--text-secondary)}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
    padding:.7rem 1rem; border-radius:10px;
    background:var(--input-bg); color:var(--text-primary); border:1px solid var(--input-border);
    font-weight:700; cursor:pointer; transition:all .2s;
  }
  .btn:hover{background:#f1f5fa; border-color:var(--accent-primary); color:var(--accent-primary)}
  .btn:active{transform:scale(.98)}
  .btn.primary{background:var(--accent-secondary); color:#fff; border:none}
  .btn.primary:hover{background:var(--accent-secondary-dark)}
  .btn-chip{padding:.45rem .7rem; font-size:.9rem}

  .divider{height:1px;background:var(--panel-border);margin:.9rem 0;border:none}

  /* ------------------------------------------------------------------
     5) 썸네일 그리드 (요청대로 업로드 블록 안에 위치)
  ------------------------------------------------------------------ */
  .upload-block{ /* 업로드 인풋 + 썸네일을 한 블록으로 */
    padding:12px; border:1px dashed var(--panel-border); border-radius:12px;
    background:var(--input-bg);
  }
  .thumb-grid{
    /* 같은 블록 내부에 바로 표시되도록 margin-top만 */
    margin-top:10px;
    display:flex; flex-wrap:wrap; gap:10px;
    max-height:260px; overflow:auto; /* 많아지면 이 블록 안에서 스크롤 */
  }
  .thumb{
    position:relative; width:120px; height:90px; overflow:hidden;
    border:1px solid var(--panel-border); border-radius:10px; background:var(--input-bg);
  }
  .thumb img{width:100%;height:100%;object-fit:cover;transform-origin:center center;pointer-events:none}
  .index-badge{
    position:absolute;top:6px;left:6px;background:rgba(0,0,0,.6);color:#fff;border-radius:6px;padding:2px 6px;font-size:12px
  }
  .thumb .tools{position:absolute;right:6px;bottom:6px;display:flex;gap:6px}
  .thumb .tools .btn{padding:.25rem .4rem;font-size:.8rem;border-radius:8px}

  /* ------------------------------------------------------------------
     6) 프리뷰 캔버스
  ------------------------------------------------------------------ */
  .box{padding:12px;background:var(--input-bg);border:1px solid var(--input-border);border-radius:12px}
  .box h4{margin:0 0 8px}
  canvas{max-width:100%;border:1px dashed var(--panel-border);border-radius:10px;background:transparent}

  /* 로더 점 */
  .loader-container{display:flex;justify-content:center;align-items:center;gap:1rem;width:100%;min-height:120px}
  .dot-loader{width:12px;height:12px;border-radius:50%;background:var(--accent-primary);animation:bounce 1.4s infinite ease-in-out both}
  .dot-loader:nth-child(1){animation-delay:-.32s}
  .dot-loader:nth-child(2){animation-delay:-.16s}
  @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

  .hidden{display:none!important}

  /* 반응형 동일 */
  @media (max-width:900px){
    body{padding:1rem}
    #editor-sheet{flex-direction:column;gap:1.5rem}
    .settings-panel,.results-panel{width:100%;min-width:unset;max-width:none}
  }
  @media (max-width:600px){
    body{padding:.5rem}
    .container{gap:1rem}
    .app-header{padding:1rem; padding-top:4rem; border-radius:0 0 16px 16px}
    .version-info,.theme-toggle{top:1rem}
    .version-info{right:1rem; font-size:.7rem; display:flex; flex-direction:column; align-items:flex-end}
    .theme-toggle{left:1rem}
    .app-header h1{font-size:1.5rem}
  }
  </style>
</head>
<body>
  <div class="container">
    <!-- 헤더: 탭 제거, 토글/이모지/팔레트 유지 -->
    <header class="app-header">
      <div class="version-info">
        <div>Version: 1.0.1</div>
        <div>Last Updated: 2025.11.01</div>
      </div>
      <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
        <!-- 라이트/다크 이모지 동작 동일 -->
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.591a.75.75 0 11-1.06-1.06l1.591-1.591a.75.75 0 011.06 0zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM17.894 17.894a.75.75 0 01-1.06 0l-1.591-1.591a.75.75 0 011.06-1.06l1.591 1.591a.75.75 0 010 1.06zM12 18.75a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25a.75.75 0 01.75-.75zM5.106 17.894a.75.75 0 010-1.06l1.591-1.591a.75.75 0 011.06 1.06l-1.591 1.591a.75.75 0 01-1.06 0zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12z"/>
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 004.463-.949a.75.75 0 01.82.162a10.5 10.5 0 11-14.73-14.73a.75.75 0 01.819.162z" clip-rule="evenodd"/>
        </svg>
        <span id="theme-toggle-label"></span>
      </button>
      <h1>이미지 이어붙이기</h1>
    </header>

    <main class="content-wrapper">
      <div id="editor-sheet" class="sheet-content">
        <!-- 좌측: 업로드/옵션 패널 -->
        <section class="panel settings-panel">
          <div class="panel-header"><h2>업로드 및 옵션</h2></div>

          <!-- 업로드 블록: 인풋과 썸네일을 "같은 칸"에 유지 -->
          <div class="upload-block">
            <div class="input-group" style="margin-bottom:.4rem">
              <label for="fileInput">이미지 업로드</label>
              <div class="input-wrapper">
                <input id="fileInput" type="file" multiple accept="image/*" />
              </div>
              <div class="small" style="margin-top:.4rem">드래그로 순서 변경 · ↻ 회전 · ❌ 삭제 · 이름정렬</div>
              <div style="display:flex;gap:.5rem;margin-top:.6rem">
                <button id="sortAsc" class="btn btn-chip">이름순</button>
                <button id="sortDesc" class="btn btn-chip">이름 역순</button>
                <button id="clearAll" class="btn btn-chip">모두 지우기</button>
              </div>
            </div>

            <!-- ✅ 썸네일 그리드: 업로드 블록 "바로 아래" -->
            <div id="thumbContainer" class="thumb-grid"></div>
          </div>

          <hr class="divider" />

          <!-- 출력 폭 -->
          <div class="input-group" style="margin-bottom:.8rem">
            <label>가로 폭</label>
            <div style="display:flex;flex-wrap:wrap;gap:.5rem">
              <button class="btn btn-chip widthBtn active" data-width="auto">자동</button>
              <button class="btn btn-chip widthBtn" data-width="720">720</button>
              <button class="btn btn-chip widthBtn" data-width="1280">1280</button>
              <button class="btn btn-chip widthBtn" data-width="1920">1920</button>
              <button class="btn btn-chip widthBtn" data-width="2560">2560</button>
              <button class="btn btn-chip widthBtn" data-width="3840">3840</button>
            </div>
            <div class="input-wrapper" style="margin-top:.5rem">
              <input id="customWidth" type="number" placeholder="직접 입력(px)" />
            </div>
          </div>

          <!-- 배치 방식 -->
          <div class="input-group" style="margin-bottom:.8rem">
            <label>배치 방식</label>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="btn btn-chip layoutBtn active" data-layout="scale">비율 유지</button>
              <button class="btn btn-chip layoutBtn" data-layout="pad">패딩 맞춤</button>
            </div>
          </div>

          <!-- 패딩 옵션 -->
          <div id="padOptions" class="input-group hidden" style="margin-bottom:.8rem">
            <label>패딩 정렬 · 배경</label>
            <div style="display:flex; gap:.5rem; flex-wrap:wrap">
              <div class="input-wrapper" style="min-width:120px">
                <select id="padAlign">
                  <option value="left">좌</option>
                  <option value="center" selected>가운데</option>
                  <option value="right">우</option>
                </select>
              </div>
              <div class="input-wrapper" style="min-width:180px">
                <select id="padBg">
                  <option value="transparent" selected>투명 (PNG 전용)</option>
                  <option value="#ffffff">흰색</option>
                  <option value="#000000">검정</option>
                </select>
              </div>
              <div class="small">JPEG에서는 투명이 흰색으로 렌더링</div>
            </div>
          </div>

          <!-- 간격 -->
          <div class="input-group" style="margin-bottom:.8rem">
            <label for="gapInput">이미지 간격</label>
            <div class="input-wrapper"><input id="gapInput" type="number" value="0"/><span style="padding:0 12px;color:var(--text-secondary)">px</span></div>
          </div>

          <!-- 포맷/품질 -->
          <div class="input-group">
            <label>출력 형식</label>
            <div style="display:flex; gap:.5rem; flex-wrap:wrap">
              <button class="btn btn-chip fmtBtn active" data-format="image/jpeg">JPEG</button>
              <button class="btn btn-chip fmtBtn" data-format="image/png">PNG</button>
            </div>
          </div>
          <div id="jpegQualityRow" class="input-group" style="margin-top:.6rem">
            <label for="qualityInput">JPEG 품질</label>
            <div class="input-wrapper"><input id="qualityInput" type="number" min="50" max="100" step="1" value="100"/><span style="padding:0 12px;color:var(--text-secondary)">%</span></div>
          </div>

          <hr class="divider" />

          <!-- 실행 버튼 -->
          <div style="display:flex; gap:.6rem; flex-wrap:wrap">
            <button id="mergeBtn" class="btn primary">이미지 합치기</button>
            <button id="downloadBtn" class="btn" disabled>다운로드</button>
          </div>
          <div id="statusLine" class="small" style="margin-top:.6rem"></div>
        </section>

        <!-- 우측: 미리보기 패널 (그대로) -->
        <section class="panel results-panel">
          <div class="panel-header">
            <h2>미리보기</h2>
            <div id="infoLine" class="small"></div>
          </div>

          <div class="box" style="margin-bottom:1rem">
            <h4>큰 미리보기 (세로 최대 10,000px)</h4>
            <div class="loader-container hidden" id="previewLoader">
              <div class="dot-loader"></div><div class="dot-loader"></div><div class="dot-loader"></div>
            </div>
            <canvas id="previewLarge"></canvas>
          </div>

          <div class="box">
            <h4>축소 미리보기</h4>
            <canvas id="previewSmall"></canvas>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
  /* ================================================================
     JS 개요
     - 테마 토글: 같은 이모지/라벨 동작 유지
     - 썸네일: 업로드 블록 내부(같은 칸)에 렌더
     - 합성: slice draw로 세로 아티팩트 회피
  ================================================================= */

  /* ---------- 0) 테마 토글 ---------- */
  const THEME_KEY='imgJoinerTheme_v1';
  const themeBtn=document.getElementById('theme-toggle');
  const themeLabel=document.getElementById('theme-toggle-label');

  function applyTheme(theme){
    if(theme==='dark'){ document.body.classList.add('dark-mode'); themeLabel.textContent='라이트 모드'; }
    else{ document.body.classList.remove('dark-mode'); themeLabel.textContent='다크 모드'; }
  }
  (function initTheme(){
    const saved=localStorage.getItem(THEME_KEY);
    const sys=matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';
    applyTheme(saved||sys);
  })();
  themeBtn.addEventListener('click',()=>{
    const next=document.body.classList.contains('dark-mode')?'light':'dark';
    applyTheme(next); localStorage.setItem(THEME_KEY,next);
  });

  /* ---------- 1) 상태/요소 참조 ---------- */
  const fileInput=document.getElementById('fileInput');
  const thumbContainer=document.getElementById('thumbContainer');
  const sortAsc=document.getElementById('sortAsc');
  const sortDesc=document.getElementById('sortDesc');
  const clearAll=document.getElementById('clearAll');

  const widthBtns=[...document.querySelectorAll('.widthBtn')];
  const layoutBtns=[...document.querySelectorAll('.layoutBtn')];
  const fmtBtns=[...document.querySelectorAll('.fmtBtn')];

  const padOptions=document.getElementById('padOptions');
  const padAlign=document.getElementById('padAlign');
  const padBg=document.getElementById('padBg');

  const customWidth=document.getElementById('customWidth');
  const gapInput=document.getElementById('gapInput');
  const qualityRow=document.getElementById('jpegQualityRow');
  const qualityInput=document.getElementById('qualityInput');

  const mergeBtn=document.getElementById('mergeBtn');
  const downloadBtn=document.getElementById('downloadBtn');

  const statusLine=document.getElementById('statusLine');
  const infoLine=document.getElementById('infoLine');
  const previewLarge=document.getElementById('previewLarge');
  const previewSmall=document.getElementById('previewSmall');
  const previewLoader=document.getElementById('previewLoader');

  // 메모리 상태
  let images=[];                 // {src,name,rotation}
  let selectedWidth='auto';      // 출력 폭
  let layout='scale';            // 'scale' | 'pad'
  let format='image/jpeg';       // 'image/jpeg' | 'image/png'
  let quality=1.0;               // JPEG 품질 (0~1)

  // 안전 상수
  const PREVIEW_MAX_H=10000;     // 큰 미리보기 세로 최대
  const SLICE_SRC_H=1024;        // 슬라이스 높이(아티팩트 회피)
  const MAX_TOTAL_MB=300;        // 업로드 총 용량 제한

  /* ---------- 2) 유틸 ---------- */
  function setActive(btns, target){ btns.forEach(b=>b.classList.toggle('active', b===target)); }
  function updateUIByFormat(){
    const isJpeg = format==='image/jpeg';
    qualityRow.style.opacity=isJpeg?'1':'.55';
    qualityInput.disabled=!isJpeg;
    // JPEG는 투명 불가 → padBg에서 'transparent' 비활성
    const transparentDisabled=isJpeg;
    [...padBg.options].forEach(o=>{ if(o.value==='transparent') o.disabled=transparentDisabled; });
    if(isJpeg && padBg.value==='transparent'){ padBg.value='#ffffff'; }
  }
  function updatePadVisibility(){ padOptions.classList.toggle('hidden', layout!=='pad'); }
  function updateStatus(){
    const w = selectedWidth==='auto' ? '자동' : `${selectedWidth}px`;
    statusLine.textContent = `폭: ${w} · 배치: ${layout==='scale'?'비율 유지':'패딩'} · 형식: ${format==='image/png'?'PNG':'JPEG'}`;
  }

  /* ---------- 3) 파일 업로드 & 썸네일 (같은 블록에 렌더) ---------- */
  fileInput.addEventListener('change',()=>{
    const files=Array.from(fileInput.files||[]);
    const totalMB=files.reduce((s,f)=>s+f.size,0)/1048576;
    if(totalMB>MAX_TOTAL_MB){ alert(`총 용량이 너무 큽니다 (≤ ${MAX_TOTAL_MB}MB)`); return; }
    images.length=0;
    files.forEach(f=>{
      const r=new FileReader();
      r.onload=e=>{ images.push({src:e.target.result,name:f.name,rotation:0}); renderThumbs(); };
      r.readAsDataURL(f);
    });
  });
  sortAsc.onclick=()=>{ images.sort((a,b)=>a.name.localeCompare(b.name,'ko')); renderThumbs(); };
  sortDesc.onclick=()=>{ images.sort((a,b)=>b.name.localeCompare(a.name,'ko')); renderThumbs(); };
  clearAll.onclick=()=>{ images.length=0; renderThumbs(); drawEmptyPreviews(); downloadBtn.disabled=true; infoLine.textContent=''; };

  // 썸네일 렌더(업로드 블록 안의 #thumbContainer에 그림)
  function renderThumbs(){
    thumbContainer.innerHTML='';
    images.forEach((o,i)=>{
      const d=document.createElement('div'); d.className='thumb'; d.draggable=true; d.dataset.index=i;
      const img=document.createElement('img'); img.src=o.src; img.style.transform=`rotate(${o.rotation}deg)`;
      const lab=document.createElement('div'); lab.className='index-badge'; lab.textContent=i+1;
      const tools=document.createElement('div'); tools.className='tools';
      const rot=document.createElement('button'); rot.className='btn'; rot.textContent='↻';
      const del=document.createElement('button'); del.className='btn'; del.textContent='❌';
      rot.onclick=()=>{ o.rotation=(o.rotation+90)%360; renderThumbs(); };
      del.onclick=()=>{ images.splice(i,1); renderThumbs(); };
      tools.append(rot,del);
      d.append(img,lab,tools); thumbContainer.appendChild(d);

      // DnD 정렬
      d.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',i));
      d.addEventListener('dragover',e=>e.preventDefault());
      d.addEventListener('drop',e=>{
        e.preventDefault();
        const from=parseInt(e.dataTransfer.getData('text/plain'),10), to=i;
        if(from!==to){ const t=images.splice(from,1)[0]; images.splice(to,0,t); renderThumbs(); }
      });
    });
  }

  /* ---------- 4) 옵션 컨트롤 ---------- */
  widthBtns.forEach(b=>b.addEventListener('click',()=>{
    setActive(widthBtns,b);
    selectedWidth = b.dataset.width==='auto' ? 'auto' : parseInt(b.dataset.width,10);
    updateStatus();
  }));
  layoutBtns.forEach(b=>b.addEventListener('click',()=>{
    setActive(layoutBtns,b);
    layout=b.dataset.layout; updatePadVisibility(); updateStatus();
  }));
  fmtBtns.forEach(b=>b.addEventListener('click',()=>{
    setActive(fmtBtns,b);
    format=b.dataset.format; updateUIByFormat(); updateStatus();
  }));
  customWidth.addEventListener('input',()=>{
    const v=parseInt(customWidth.value||'0',10);
    if(v>0){ selectedWidth=v; setActive(widthBtns,null); updateStatus(); }
  });
  qualityInput.addEventListener('input',()=>{
    // 100 또는 0~1 입력을 모두 허용
    let raw=(qualityInput.value||'').trim().replace('%','');
    if(raw==='') return;
    let v=parseFloat(raw);
    if(!isFinite(v)) return;
    if(v>0 && v<=1) v*=100;
    v=Math.max(1,Math.min(100,v));
    quality=v/100;
  });
  qualityInput.addEventListener('change',()=>{
    let v=parseInt(qualityInput.value||'100',10);
    if(!isFinite(v)) v=100;
    v=Math.max(50,Math.min(100,v));
    quality=v/100; qualityInput.value=String(v);
  });

  /* ---------- 5) 캔버스 드로잉(슬라이스로 아티팩트 방지) ---------- */
  function loadImage(obj){return new Promise(res=>{const i=new Image(); i.onload=()=>res(i); i.src=obj.src;});}

  // 회전·스케일 반영하여 세로 슬라이스로 그리기
  function drawImageSliced(ctx, img, sw, sh, dw, dh, cx, cy, rad){
    ctx.save(); ctx.translate((cx|0), (cy|0)); ctx.rotate(rad);
    ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
    const scaleX = dw / sw, scaleY = dh / sh;
    const destW = Math.max(1, Math.round(dw));
    const halfW = destW/2;
    for(let sy=0; sy<sh; sy+=SLICE_SRC_H){
      const shSeg=Math.min(SLICE_SRC_H, sh - sy);
      const dhSeg=shSeg*scaleY;
      const dy=-dh/2 + sy*scaleY;
      ctx.drawImage(
        img,
        0, sy, sw, shSeg,
        Math.round(-halfW), Math.round(dy),
        destW, Math.max(1, Math.round(dhSeg))
      );
    }
    ctx.restore();
  }

  // 레이아웃 계산 (세로 이어붙이기)
  async function buildLayout(){
    const imgs=await Promise.all(images.map(loadImage));
    const gap=parseInt(gapInput.value||'0',10);

    // 기준 폭: 자동이면 가장 넓은 폭(회전 반영)
    let baseW = (selectedWidth==='auto')
      ? Math.max(...imgs.map((im,idx)=>((images[idx].rotation%180===0)?im.width:im.height)))
      : selectedWidth;

    // 아이템별 실제 드로잉 크기 계산
    const items=[];
    for(let i=0;i<imgs.length;i++){
      const img=imgs[i]; const rot=images[i].rotation%360; const rad=rot*Math.PI/180;
      const ow=img.width, oh=img.height;
      const effW=(rot%180===0)?ow:oh, effH=(rot%180===0)?oh:ow;
      const s = (layout==='pad') ? (effW>baseW ? baseW/effW : 1) : (baseW/effW);
      items.push({
        img, rot, rad,
        drawWsrc: ow*s, drawHsrc: oh*s,    // 소스 기준 스케일
        drawWeff: effW*s, drawHeff: effH*s // 레이아웃 기준 크기
      });
    }

    // 배치(세로로 쌓기)
    const placements=[];
    let totalW=baseW, y=0;
    for(const it of items){
      const tileW=baseW, tileH=it.drawHeff;
      // pad 모드일 때 좌/중/우 정렬
      let x=0;
      if(layout==='pad'){
        if(padAlign.value==='center') x=(tileW-it.drawWeff)/2;
        else if(padAlign.value==='right') x=(tileW-it.drawWeff);
      }
      placements.push({x,y,w:tileW,h:tileH,it});
      y+=tileH + gap;
    }
    const totalH = placements.length ? (placements.at(-1).y + placements.at(-1).h) : 0;
    return {placements,totalW,totalH};
  }

  // 프리뷰 렌더 (큰/작은)
  async function renderPreview(canvas, placements, totalW, totalH, maxW, maxH){
    const ctx=canvas.getContext('2d',{alpha:true});
    const scale=Math.min(maxW/totalW, maxH/totalH, 1);
    canvas.width=Math.max(1, Math.floor(totalW*scale));
    canvas.height=Math.max(1, Math.floor(totalH*scale));
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
    for(const p of placements){
      drawImageSliced(
        ctx, p.it.img,
        p.it.img.width, p.it.img.height,
        Math.max(1, Math.round(p.it.drawWsrc*scale)),
        Math.max(1, Math.round(p.it.drawHsrc*scale)),
        Math.round((p.x + p.it.drawWeff/2)*scale),
        Math.round((p.y + p.it.drawHeff/2)*scale),
        p.it.rad
      );
    }
  }

  // 최종 Blob 생성
  async function buildBlob(placements,totalW,totalH){
    const useOff = typeof OffscreenCanvas!=='undefined';
    let c, ctx;
    if(useOff){ c=new OffscreenCanvas(totalW, totalH); ctx=c.getContext('2d',{alpha:true}); }
    else{ c=document.createElement('canvas'); c.width=totalW; c.height=totalH; ctx=c.getContext('2d',{alpha:true}); }

    // 배경 처리: PNG + transparent면 투명, 아니면 색/흰색
    if(format==='image/png' && padBg.value==='transparent'){ ctx.clearRect(0,0,totalW,totalH); }
    else{
      const fill=(layout==='pad') ? (padBg.value==='transparent'?'#ffffff':padBg.value) : '#ffffff';
      ctx.fillStyle=fill; ctx.fillRect(0,0,totalW,totalH);
    }

    ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
    for(const p of placements){
      drawImageSliced(ctx, p.it.img, p.it.img.width, p.it.img.height, p.it.drawWsrc, p.it.drawHsrc, p.x + p.it.drawWeff/2, p.y + p.it.drawHeff/2, p.it.rad);
    }

    if(useOff){ return await c.convertToBlob({type:format, quality:(format==='image/jpeg'?quality:undefined)}); }
    return await new Promise(res=>c.toBlob(b=>res(b), format, (format==='image/jpeg'?quality:undefined)));
  }

  /* ---------- 6) 합치기 플로우 ---------- */
  function drawEmptyPreviews(){ previewLarge.width=1; previewLarge.height=1; previewSmall.width=1; previewSmall.height=1; }

  document.getElementById('mergeBtn').addEventListener('click', async ()=>{
    if(!images.length){ alert('이미지를 먼저 업로드하세요.'); return; }
    try{
      previewLoader.classList.remove('hidden');
      const t0=performance.now();

      const {placements,totalW,totalH}=await buildLayout();
      await renderPreview(previewLarge, placements, totalW, totalH, 2000, PREVIEW_MAX_H);
      await renderPreview(previewSmall, placements, totalW, totalH, 700, 380);

      const blob=await buildBlob(placements,totalW,totalH);
      const mb=(blob.size/1048576).toFixed(2);
      const mp=(totalW*totalH/1e6).toFixed(1);
      infoLine.textContent=`${images.length}장 · ${totalW}×${totalH} (${mp}MP) · ${format.split('/')[1].toUpperCase()} · ${mb}MB · ${((performance.now()-t0)/1000).toFixed(2)}s`;

      // 다운로드 버튼 활성화
      downloadBtn.disabled=false;
      downloadBtn.onclick=()=>{
        const a=document.createElement('a');
        const d=new Date(); const ts=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
        a.download=`merged_${ts}.${format==='image/png'?'png':'jpg'}`;
        a.href=URL.createObjectURL(blob);
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href),1000);
      };

    }catch(err){
      console.error(err); alert('처리 중 오류가 발생했습니다.');
    }finally{
      previewLoader.classList.add('hidden');
    }
  });

  /* ---------- 7) 초기 상태 ---------- */
  function updateAll(){ updateStatus(); updateUIByFormat(); updatePadVisibility(); }
  updateAll(); renderThumbs(); drawEmptyPreviews();

  // 클립보드 붙여넣기 지원(동일한 칸으로 들어오게)
  document.addEventListener('paste',e=>{
    const items=e.clipboardData?.items; if(!items) return;
    for(const it of items){
      if(it.type?.startsWith('image/')){
        const b=it.getAsFile(); const r=new FileReader();
        r.onload=ev=>{ images.push({src:ev.target.result,name:`clipboard_${images.length+1}.png`,rotation:0}); renderThumbs(); };
        r.readAsDataURL(b);
      }
    }
  });
  </script>
</body>
</html>
