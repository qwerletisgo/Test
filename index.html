<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ïù¥ÎØ∏ÏßÄ Ïù¥Ïñ¥Î∂ôÏù¥Í∏∞</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß©</text></svg>">
<style>
/* --- Root Variables (from your theme) --- */
:root{
  --background-color:#f4f6f9;
  --panel-bg:#ffffff;
  --panel-border:#e0e6ed;
  --text-primary:#2c3e50;
  --text-secondary:#8a95a5;
  --header-bg:#2c3e50;
  --accent-primary:#3498db;
  --accent-primary-dark:#2980b9;
  --accent-secondary:#2ecc71;
  --accent-secondary-dark:#27ae60;
  --input-bg:#ffffff;
  --input-border:#dce1e6;
  --shadow:rgba(44,62,80,.1);
  --inactive-tab-bg:#5f7a95;

  --font-primary:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,'Noto Sans KR',sans-serif;
  --font-secondary:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,'Noto Sans KR',sans-serif;
}
body.dark-mode{
  --background-color:#1c2128;
  --panel-bg:#2d333b;
  --panel-border:#444c56;
  --text-primary:#e6edf3;
  --text-secondary:#909dab;
  --header-bg:#2d333b;
  --accent-primary:#58a6ff;
  --accent-primary-dark:#388bfd;
  --accent-secondary:#34d399;
  --accent-secondary-dark:#10b981;
  --input-bg:#22272e;
  --input-border:#444c56;
  --shadow:rgba(0,0,0,.4);
  --inactive-tab-bg:#444c56;
}

/* --- Base --- */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:var(--font-secondary);
  font-size:16px;
  background:var(--background-color);
  color:var(--text-primary);
  display:flex;justify-content:center;align-items:flex-start;
  min-height:100vh; padding:2rem; transition:background-color .3s,color .3s;
}
.container{width:100%;max-width:1200px;display:flex;flex-direction:column;gap:1.5rem;align-items:center}
.content-wrapper{width:100%}

/* --- Header (copying structure) --- */
.app-header{
  width:100%; background:var(--header-bg); color:#fff;
  padding:1.5rem 2rem; border-radius:16px; text-align:center;
  box-shadow:0 8px 32px var(--shadow); position:relative; transition:background-color .3s;
}
.app-header h1{font-size:1.75rem;font-weight:600;margin-bottom:1rem}
.version-info{
  position:absolute; top:1.5rem; right:2rem; text-align:right; font-size:.8rem;
  color:rgba(255,255,255,.8); line-height:1.4;
}
body.dark-mode .version-info{color:var(--text-secondary)}

/* theme toggle button (same icons behavior) */
.theme-toggle{
  position:absolute; top:1.5rem; left:2rem;
  background:var(--inactive-tab-bg); border:1px solid transparent; color:#fff;
  padding:.5rem 1rem; border-radius:20px; display:flex; align-items:center; gap:.5rem;
  font-weight:600; font-size:.9rem; cursor:pointer; transition:all .2s;
}
.theme-toggle:hover{background:var(--accent-primary)}
.theme-toggle:active{transform:scale(.97)}
.theme-toggle .sun-icon,.theme-toggle .moon-icon{display:none}
body:not(.dark-mode) .theme-toggle .moon-icon{display:block}
body.dark-mode .theme-toggle .sun-icon{display:block}
body.dark-mode .theme-toggle{background:var(--input-bg); color:var(--text-primary); border:1px solid var(--panel-border)}
body.dark-mode .theme-toggle:hover{border-color:var(--accent-primary); color:var(--accent-primary)}

/* --- Tabs (visual only) --- */
.sheet-nav{display:flex;justify-content:center;gap:.5rem;flex-wrap:wrap}
.sheet-nav button{
  padding:.6rem 1.5rem; font-size:1rem; font-weight:600; font-family:var(--font-secondary);
  background:var(--inactive-tab-bg); color:#f0f4f8; border:none; border-radius:8px; cursor:pointer; transition:all .2s;
}
.sheet-nav button:hover{opacity:.9}
.sheet-nav button.active{background:var(--accent-primary); color:#fff; box-shadow:0 2px 10px rgba(52,152,219,.4)}
body.dark-mode .sheet-nav button.active{box-shadow:0 2px 10px rgba(74,144,226,.4)}

/* --- Panels --- */
.panel{
  background:var(--panel-bg); border:1px solid var(--panel-border); border-radius:16px;
  box-shadow:0 8px 32px var(--shadow); padding:2rem; transition:background-color .3s,border-color .3s;
}
.panel-header{
  margin-bottom:1.2rem; border-bottom:2px solid var(--accent-primary);
  padding-bottom:.75rem; display:flex; justify-content:space-between; align-items:center;
}
.panel-header h2{font-size:1.25rem; font-weight:700; color:var(--text-primary)}
.settings-panel{flex:1;min-width:320px;max-width:460px}
.results-panel{flex:2;min-width:420px}
.sheet-content{width:100%}
#editor-sheet{display:flex;gap:2rem;align-items:flex-start}

/* --- Inputs --- */
.input-group{display:flex;flex-direction:column}
.input-group label{font-size:.9rem;font-weight:600;color:var(--text-primary);margin-bottom:.5rem}
.input-wrapper{
  position:relative; display:flex; align-items:center; background:var(--input-bg);
  border:1px solid var(--input-border); border-radius:8px; overflow:hidden; transition:border-color .2s,box-shadow .2s,background-color .3s;
}
.input-wrapper:focus-within{border-color:var(--accent-primary); box-shadow:0 0 0 3px rgba(52,152,219,.2)}
body.dark-mode .input-wrapper:focus-within{box-shadow:0 0 0 3px rgba(88,166,255,.25)}
.input-wrapper input,.input-wrapper select{
  width:100%; background:transparent; border:none; padding:.8rem 1rem; font-size:1rem; color:var(--text-primary); font-family:var(--font-secondary)
}
.input-wrapper input[type="number"]{text-align:right}
.input-wrapper select{appearance:none; padding-right:2.2rem; cursor:pointer}
.input-wrapper .select-arrow{
  position:absolute; right:0; top:0; bottom:0; padding:0 .75rem; pointer-events:none; display:flex; align-items:center; color:var(--text-secondary)
}
.input-wrapper span{
  padding:0 1rem; color:var(--text-secondary); font-size:.9rem; white-space:nowrap; background:#f8f9fa; border-left:1px solid var(--input-border); transition:background-color .3s,border-color .3s;
}
body.dark-mode .input-wrapper span{background:#3a4049; border-left-color:var(--input-border)}

/* --- Buttons --- */
.btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.7rem 1rem;
  background:var(--input-bg); color:var(--text-primary); border:1px solid var(--input-border);
  border-radius:10px; cursor:pointer; font-weight:700; transition:all .2s}
.btn:hover{background-color:#f1f5fa; border-color:var(--accent-primary); color:var(--accent-primary)}
.btn:active{transform:scale(.98)}
.btn.primary{background:var(--accent-secondary); color:#fff; border:none}
.btn.primary:hover{background:var(--accent-secondary-dark)}
.btn.secondary{background:#f8f9fa}
.btn-chip{padding:.45rem .7rem; font-size:.9rem}

/* --- Thumbs --- */
.thumb-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
.thumb{
  position:relative;width:120px;height:90px;overflow:hidden;border:1px solid var(--panel-border);
  border-radius:10px;background:var(--input-bg)
}
.thumb img{width:100%;height:100%;object-fit:cover;transform-origin:center center;pointer-events:none}
.index-badge{
  position:absolute;top:6px;left:6px;background:rgba(0,0,0,.6);color:#fff;border-radius:6px;padding:2px 6px;font-size:12px
}
.thumb .tools{position:absolute;right:6px;bottom:6px;display:flex;gap:6px}
.thumb .tools .btn{padding:.25rem .4rem;font-size:.8rem;border-radius:8px}

/* --- Preview Boxes --- */
.box{padding:12px;background:var(--input-bg);border:1px solid var(--input-border);border-radius:12px}
.box h4{margin:0 0 8px}
canvas{max-width:100%;border:1px dashed var(--panel-border);border-radius:10px;background:transparent}

/* --- Loader --- */
.loader-container{display:flex;justify-content:center;align-items:center;gap:1rem;width:100%;min-height:120px}
.dot-loader{width:12px;height:12px;border-radius:50%;background:var(--accent-primary);animation:bounce 1.4s infinite ease-in-out both}
.dot-loader:nth-child(1){animation-delay:-.32s}
.dot-loader:nth-child(2){animation-delay:-.16s}
@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

/* --- Utils --- */
.hidden{display:none!important}
.small{font-size:.85rem;color:var(--text-secondary)}
.divider{height:1px;background:var(--panel-border);margin:.75rem 0;border:none}
.width-grid{display:flex;flex-wrap:wrap;gap:.5rem}
.width-grid .btn{flex:1 1 120px}

/* --- Responsive --- */
@media (max-width:900px){
  body{padding:1rem}
  #editor-sheet{flex-direction:column;gap:1.5rem}
  .settings-panel,.results-panel{width:100%;min-width:unset;max-width:none}
}
@media (max-width:600px){
  body{padding:.5rem}
  .container{gap:1rem}
  .app-header{padding:1rem; padding-top:4rem; border-radius:0 0 16px 16px}
  .version-info,.theme-toggle{top:1rem}
  .version-info{right:1rem; font-size:.7rem; display:flex; flex-direction:column; align-items:flex-end}
  .theme-toggle{left:1rem}
  .app-header h1{font-size:1.5rem}
}
</style>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="version-info">
        <div>Version: 1.0.0</div>
        <div>Last Updated: 2025.11.01</div>
      </div>
      <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
        <!-- same icons behavior -->
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.591a.75.75 0 11-1.06-1.06l1.591-1.591a.75.75 0 011.06 0zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM17.894 17.894a.75.75 0 01-1.06 0l-1.591-1.591a.75.75 0 011.06-1.06l1.591 1.591a.75.75 0 010 1.06zM12 18.75a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25a.75.75 0 01.75-.75zM5.106 17.894a.75.75 0 010-1.06l1.591-1.591a.75.75 0 011.06 1.06l-1.591 1.591a.75.75 0 01-1.06 0zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM6.106 6.106a.75.75 0 011.06 0l1.591 1.591a.75.75 0 01-1.06 1.06L6.106 7.166a.75.75 0 010-1.06z"/>
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
          <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 004.463-.949a.75.75 0 01.82.162a10.5 10.5 0 11-14.73-14.73a.75.75 0 01.819.162z" clip-rule="evenodd"/>
        </svg>
        <span id="theme-toggle-label"></span>
      </button>
      <h1>Ïù¥ÎØ∏ÏßÄ Ïù¥Ïñ¥Î∂ôÏù¥Í∏∞</h1>
      <nav class="sheet-nav">
        <button class="active" type="button">Ìé∏ÏßëÍ∏∞</button>
        <button type="button" disabled>ÎØ∏Î¶¨Î≥¥Í∏∞</button>
        <button type="button" disabled>ÏÑ§Ï†ï</button>
      </nav>
    </header>

    <main class="content-wrapper">
      <div id="editor-sheet" class="sheet-content">
        <!-- Ï¢å: ÏÑ§Ï†ï -->
        <section class="panel settings-panel">
          <div class="panel-header"><h2>ÏòµÏÖò</h2></div>

          <div class="input-group" style="margin-bottom:.6rem">
            <label>Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</label>
            <div class="input-wrapper">
              <input id="fileInput" type="file" multiple accept="image/*"/>
            </div>
            <div class="small" style="margin-top:.4rem">ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑú Î≥ÄÍ≤Ω ¬∑ ‚Üª ÌöåÏ†Ñ ¬∑ ‚ùå ÏÇ≠Ï†ú ¬∑ Ïù¥Î¶ÑÏ†ïÎ†¨</div>
            <div style="display:flex;gap:.5rem;margin-top:.6rem">
              <button id="sortAsc" class="btn btn-chip">Ïù¥Î¶ÑÏàú</button>
              <button id="sortDesc" class="btn btn-chip">Ïù¥Î¶Ñ Ïó≠Ïàú</button>
              <button id="clearAll" class="btn btn-chip">Î™®Îëê ÏßÄÏö∞Í∏∞</button>
            </div>
          </div>

          <hr class="divider"/>

          <div class="input-group">
            <label>Í∞ÄÎ°ú Ìè≠</label>
            <div class="width-grid">
              <button class="btn widthBtn active" data-width="auto">ÏûêÎèô</button>
              <button class="btn widthBtn" data-width="720">720</button>
              <button class="btn widthBtn" data-width="1280">1280</button>
              <button class="btn widthBtn" data-width="1920">1920</button>
              <button class="btn widthBtn" data-width="2560">2560</button>
              <button class="btn widthBtn" data-width="3840">3840</button>
              <div class="input-wrapper" style="flex:1 1 160px">
                <input id="customWidth" type="number" placeholder="ÏßÅÏ†ë ÏûÖÎ†•(px)"/>
              </div>
            </div>
          </div>

          <div class="input-group" style="margin-top:1rem">
            <label>Î∞∞Ïπò Î∞©Ïãù</label>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="btn btn-chip layoutBtn active" data-layout="scale">ÎπÑÏú® Ïú†ÏßÄ (ÌôïÎåÄ/Ï∂ïÏÜå)</button>
              <button class="btn btn-chip layoutBtn" data-layout="pad">Ìå®Îî© ÎßûÏ∂§</button>
            </div>
          </div>

          <div id="padOptions" class="input-group hidden" style="margin-top:.6rem">
            <label>Ìå®Îî© Ï†ïÎ†¨ ¬∑ Î∞∞Í≤Ω</label>
            <div style="display:flex; gap:.5rem; flex-wrap:wrap">
              <div class="input-wrapper" style="min-width:120px">
                <select id="padAlign">
                  <option value="left">Ï¢å</option>
                  <option value="center" selected>Í∞ÄÏö¥Îç∞</option>
                  <option value="right">Ïö∞</option>
                </select>
                <i class="select-arrow">‚ñæ</i>
              </div>
              <div class="input-wrapper" style="min-width:180px">
                <select id="padBg">
                  <option value="transparent" selected>Ìà¨Î™Ö (PNG Ï†ÑÏö©)</option>
                  <option value="#ffffff">Ìù∞ÏÉâ</option>
                  <option value="#000000">Í≤ÄÏ†ï</option>
                </select>
                <i class="select-arrow">‚ñæ</i>
              </div>
              <div class="small">JPEGÏóêÏÑúÎäî Ìà¨Î™ÖÏù¥ Ìù∞ÏÉâÏúºÎ°ú Î†åÎçîÎßÅ</div>
            </div>
          </div>

          <div class="input-group" style="margin-top:1rem">
            <label for="gapInput">Ïù¥ÎØ∏ÏßÄ Í∞ÑÍ≤©</label>
            <div class="input-wrapper"><input id="gapInput" type="number" value="0"/><span>px</span></div>
          </div>

          <div class="input-group" style="margin-top:1rem">
            <label>Ï∂úÎ†• ÌòïÏãù</label>
            <div style="display:flex; gap:.5rem; flex-wrap:wrap">
              <button class="btn btn-chip fmtBtn active" data-format="image/jpeg">JPEG</button>
              <button class="btn btn-chip fmtBtn" data-format="image/png">PNG</button>
            </div>
          </div>

          <div id="jpegQualityRow" class="input-group" style="margin-top:.6rem">
            <label for="qualityInput">JPEG ÌíàÏßà</label>
            <div class="input-wrapper"><input id="qualityInput" type="number" min="50" max="100" step="1" value="100"/><span>%</span></div>
          </div>

          <hr class="divider"/>

          <div style="display:flex; gap:.6rem; flex-wrap:wrap">
            <button id="mergeBtn" class="btn primary">Ïù¥ÎØ∏ÏßÄ Ìï©ÏπòÍ∏∞</button>
            <button id="downloadBtn" class="btn" disabled>Îã§Ïö¥Î°úÎìú</button>
          </div>
          <div id="statusLine" class="small" style="margin-top:.6rem"></div>
        </section>

        <!-- Ïö∞: Î¶¨Ïä§Ìä∏ + ÌîÑÎ¶¨Î∑∞ -->
        <section class="panel results-panel">
          <div class="panel-header">
            <h2>ÎØ∏Î¶¨Î≥¥Í∏∞</h2>
            <div id="infoLine" class="small"></div>
          </div>

          <div id="thumbContainer" class="thumb-list"></div>
          <hr class="divider"/>

          <div class="box" style="margin-bottom:1rem">
            <h4>ÌÅ∞ ÎØ∏Î¶¨Î≥¥Í∏∞ (ÏÑ∏Î°ú ÏµúÎåÄ 10,000px)</h4>
            <div class="loader-container hidden" id="previewLoader"><div class="dot-loader"></div><div class="dot-loader"></div><div class="dot-loader"></div></div>
            <canvas id="previewLarge"></canvas>
          </div>

          <div class="box">
            <h4>Ï∂ïÏÜå ÎØ∏Î¶¨Î≥¥Í∏∞</h4>
            <canvas id="previewSmall"></canvas>
          </div>
        </section>
      </div>
    </main>
  </div>

<script>
/* ---------- Theme ---------- */
const THEME_KEY='imgJoinerTheme_v1';
const themeBtn=document.getElementById('theme-toggle');
const themeLabel=document.getElementById('theme-toggle-label');
function applyTheme(theme){
  if(theme==='dark'){document.body.classList.add('dark-mode'); themeLabel.textContent='ÎùºÏù¥Ìä∏ Î™®Îìú';}
  else{document.body.classList.remove('dark-mode'); themeLabel.textContent='Îã§ÌÅ¨ Î™®Îìú';}
}
function loadTheme(){
  const saved=localStorage.getItem(THEME_KEY);
  const sys=window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';
  applyTheme(saved||sys);
}
themeBtn.addEventListener('click',()=>{
  const next=document.body.classList.contains('dark-mode')?'light':'dark';
  applyTheme(next); localStorage.setItem(THEME_KEY,next);
});
loadTheme();

/* ---------- State ---------- */
const fileInput=document.getElementById('fileInput');
const thumbContainer=document.getElementById('thumbContainer');
const sortAsc=document.getElementById('sortAsc');
const sortDesc=document.getElementById('sortDesc');
const clearAll=document.getElementById('clearAll');

const widthBtns=[...document.querySelectorAll('.widthBtn')];
const layoutBtns=[...document.querySelectorAll('.layoutBtn')];
const fmtBtns=[...document.querySelectorAll('.fmtBtn')];

const padOptions=document.getElementById('padOptions');
const padAlign=document.getElementById('padAlign');
const padBg=document.getElementById('padBg');

const customWidth=document.getElementById('customWidth');
const gapInput=document.getElementById('gapInput');
const qualityRow=document.getElementById('jpegQualityRow');
const qualityInput=document.getElementById('qualityInput');

const mergeBtn=document.getElementById('mergeBtn');
const downloadBtn=document.getElementById('downloadBtn');

const statusLine=document.getElementById('statusLine');
const infoLine=document.getElementById('infoLine');
const previewLarge=document.getElementById('previewLarge');
const previewSmall=document.getElementById('previewSmall');
const previewLoader=document.getElementById('previewLoader');

let images=[]; // {src,name,rotation}
let selectedWidth='auto';
let layout='scale'; // 'scale' | 'pad'
let format='image/jpeg';
let quality=1.0;

const PREVIEW_MAX_H=10000;     // ÏïàÏ†Ñ ÌîÑÎ¶¨Î∑∞ ÏÑ∏Î°ú ÏµúÎåÄ
const SLICE_SRC_H=1024;        // WebKit/Skia ÏïÑÌã∞Ìå©Ìä∏ ÌöåÌîº
const MAX_TOTAL_MB=300;

/* ---------- Helpers ---------- */
function setActive(btns, target){
  btns.forEach(b=>b.classList.toggle('active', b===target));
}
function updateUIByFormat(){
  const isJpeg = format==='image/jpeg';
  qualityRow.style.opacity=isJpeg?'1':'.55';
  qualityInput.disabled=!isJpeg;
  const transparentOption=[...padBg.options].find(o=>o.value==='transparent');
  transparentOption.disabled=isJpeg; // JPEG Ìà¨Î™Ö Î∂àÍ∞Ä
  if(isJpeg && padBg.value==='transparent'){ padBg.value='#ffffff'; }
}
function updatePadVisibility(){ padOptions.classList.toggle('hidden', layout!=='pad'); }
function updateStatus(){
  const w = selectedWidth==='auto' ? 'ÏûêÎèô' : `${selectedWidth}px`;
  statusLine.textContent = `Ìè≠: ${w} ¬∑ Î∞∞Ïπò: ${layout==='scale'?'ÎπÑÏú® Ïú†ÏßÄ':'Ìå®Îî©'} ¬∑ ÌòïÏãù: ${format==='image/png'?'PNG':'JPEG'}`;
}

/* ---------- File load ---------- */
fileInput.addEventListener('change',()=>{
  const files=Array.from(fileInput.files||[]);
  const totalMB=files.reduce((s,f)=>s+f.size,0)/1048576;
  if(totalMB>MAX_TOTAL_MB){ alert(`Ï¥ù Ïö©ÎüâÏù¥ ÎÑàÎ¨¥ ÌÅΩÎãàÎã§ (‚â§ ${MAX_TOTAL_MB}MB)`); return; }
  images=[];
  files.forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{ images.push({src:e.target.result,name:f.name,rotation:0}); renderThumbs(); };
    r.readAsDataURL(f);
  });
});
sortAsc.onclick=()=>{ images.sort((a,b)=>a.name.localeCompare(b.name,'ko')); renderThumbs(); };
sortDesc.onclick=()=>{ images.sort((a,b)=>b.name.localeCompare(a.name,'ko')); renderThumbs(); };
clearAll.onclick=()=>{ images=[]; renderThumbs(); drawEmptyPreviews(); downloadBtn.disabled=true; infoLine.textContent=''; };

/* ---------- Thumbs / DnD ---------- */
function renderThumbs(){
  thumbContainer.innerHTML='';
  images.forEach((o,i)=>{
    const d=document.createElement('div'); d.className='thumb'; d.draggable=true; d.dataset.index=i;
    const img=document.createElement('img'); img.src=o.src; img.style.transform=`rotate(${o.rotation}deg)`;
    const lab=document.createElement('div'); lab.className='index-badge'; lab.textContent=i+1;
    const tools=document.createElement('div'); tools.className='tools';
    const rot=document.createElement('button'); rot.className='btn'; rot.textContent='‚Üª';
    const del=document.createElement('button'); del.className='btn'; del.textContent='‚ùå';
    rot.onclick=()=>{ o.rotation=(o.rotation+90)%360; renderThumbs(); };
    del.onclick=()=>{ images.splice(i,1); renderThumbs(); };
    tools.append(rot,del);
    d.append(img,lab,tools); thumbContainer.appendChild(d);
    d.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',i));
    d.addEventListener('dragover',e=>e.preventDefault());
    d.addEventListener('drop',e=>{
      e.preventDefault();
      const from=parseInt(e.dataTransfer.getData('text/plain'),10), to=i;
      if(from!==to){ const t=images.splice(from,1)[0]; images.splice(to,0,t); renderThumbs(); }
    });
  });
}

/* ---------- Controls ---------- */
widthBtns.forEach(b=>b.addEventListener('click',()=>{
  setActive(widthBtns,b);
  selectedWidth = b.dataset.width==='auto' ? 'auto' : parseInt(b.dataset.width,10);
  updateStatus();
}));
layoutBtns.forEach(b=>b.addEventListener('click',()=>{
  setActive(layoutBtns,b);
  layout=b.dataset.layout; updatePadVisibility(); updateStatus();
}));
fmtBtns.forEach(b=>b.addEventListener('click',()=>{
  setActive(fmtBtns,b);
  format=b.dataset.format; updateUIByFormat(); updateStatus();
}));
customWidth.addEventListener('input',()=>{
  const v=parseInt(customWidth.value||'0',10);
  if(v>0){ selectedWidth=v; setActive(widthBtns, null); updateStatus(); }
});
qualityInput.addEventListener('input',()=>{
  let raw=(qualityInput.value||'').trim().replace('%','');
  if(raw==='') return;
  let v=parseFloat(raw);
  if(!isFinite(v)) return;
  if(v>0 && v<=1) v*=100;
  v=Math.max(1,Math.min(100,v));
  quality=v/100;
});
qualityInput.addEventListener('change',()=>{
  let v=parseInt(qualityInput.value||'100',10);
  if(!isFinite(v)) v=100;
  v=Math.max(50,Math.min(100,v));
  quality=v/100; qualityInput.value=String(v);
});

/* ---------- Drawing (slice to avoid artifacts) ---------- */
function loadImage(obj){return new Promise(res=>{const i=new Image(); i.onload=()=>res(i); i.src=obj.src;});}

function drawImageSliced(ctx, img, sw, sh, dw, dh, cx, cy, rad){
  ctx.save(); ctx.translate(cx|0, cy|0); ctx.rotate(rad);
  ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
  const scaleX = dw / sw, scaleY = dh / sh;
  const destW = Math.max(1, Math.round(dw));
  const halfW = destW/2;
  for(let sy=0; sy<sh; sy+=SLICE_SRC_H){
    const shSeg=Math.min(SLICE_SRC_H, sh - sy);
    const dhSeg=shSeg*scaleY;
    const dy=-dh/2 + sy*scaleY;
    ctx.drawImage(
      img,
      0, sy, sw, shSeg,
      Math.round(-halfW), Math.round(dy),
      destW, Math.max(1, Math.round(dhSeg))
    );
  }
  ctx.restore();
}

async function buildLayout(){
  const imgs=await Promise.all(images.map(loadImage));
  const gap=parseInt(gapInput.value||'0',10);
  let baseW=selectedWidth==='auto' ? Math.max(...imgs.map((im,idx)=>((images[idx].rotation%180===0)?im.width:im.height))) : selectedWidth;
  const custom=parseInt(customWidth.value||'0',10); if(custom>0) baseW=custom;

  const items=[];
  for(let i=0;i<imgs.length;i++){
    const img=imgs[i]; const rot=images[i].rotation%360; const rad=rot*Math.PI/180;
    const ow=img.width, oh=img.height;
    const effW=(rot%180===0)?ow:oh, effH=(rot%180===0)?oh:ow;
    const s = (layout==='pad') ? (effW>baseW ? baseW/effW : 1) : (baseW/effW);
    items.push({
      img, rot, rad,
      drawWsrc: ow*s, drawHsrc: oh*s,
      drawWeff: effW*s, drawHeff: effH*s
    });
  }

  const placements=[];
  let totalW=baseW, y=0;
  for(const it of items){
    const tileW=baseW, tileH=it.drawHeff;
    let x=0;
    if(layout==='pad'){
      if(padAlign.value==='center') x=(tileW-it.drawWeff)/2;
      else if(padAlign.value==='right') x=(tileW-it.drawWeff);
      else x=0;
    }
    placements.push({x,y,w:tileW,h:tileH,it});
    y+=tileH + gap;
  }
  const totalH = placements.length ? (placements.at(-1).y + placements.at(-1).h) : 0;
  return {placements, totalW, totalH};
}

async function renderPreview(canvas, placements, totalW, totalH, maxW, maxH){
  const ctx=canvas.getContext('2d',{alpha:true});
  const scale=Math.min(maxW/totalW, maxH/totalH, 1);
  canvas.width=Math.max(1, Math.floor(totalW*scale));
  canvas.height=Math.max(1, Math.floor(totalH*scale));
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
  for(const p of placements){
    drawImageSliced(
      ctx, p.it.img,
      p.it.img.width, p.it.img.height,
      Math.max(1, Math.round(p.it.drawWsrc*scale)),
      Math.max(1, Math.round(p.it.drawHsrc*scale)),
      Math.round((p.x + p.it.drawWeff/2)*scale),
      Math.round((p.y + p.it.drawHeff/2)*scale),
      p.it.rad
    );
  }
}

async function buildBlob(placements, totalW, totalH){
  const useOff = typeof OffscreenCanvas!=='undefined';
  let c, ctx;
  if(useOff){ c=new OffscreenCanvas(totalW, totalH); ctx=c.getContext('2d',{alpha:true}); }
  else{ c=document.createElement('canvas'); c.width=totalW; c.height=totalH; ctx=c.getContext('2d',{alpha:true}); }
  // background
  if(format==='image/png' && padBg.value==='transparent'){ ctx.clearRect(0,0,totalW,totalH); }
  else{
    const fill = (layout==='pad') ? (padBg.value==='transparent' ? '#ffffff' : padBg.value) : '#ffffff';
    ctx.fillStyle=fill; ctx.fillRect(0,0,totalW,totalH);
  }
  ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
  for(const p of placements){
    drawImageSliced(ctx, p.it.img, p.it.img.width, p.it.img.height, p.it.drawWsrc, p.it.drawHsrc, p.x + p.it.drawWeff/2, p.y + p.it.drawHeff/2, p.it.rad);
  }
  if(useOff){ return await c.convertToBlob({type:format, quality:(format==='image/jpeg'?quality:undefined)}); }
  return await new Promise(res=>c.toBlob(b=>res(b), format, (format==='image/jpeg'?quality:undefined)));
}

/* ---------- Merge flow ---------- */
function drawEmptyPreviews(){ previewLarge.width=1; previewLarge.height=1; previewSmall.width=1; previewSmall.height=1; }
mergeBtn.addEventListener('click', async ()=>{
  if(!images.length){ alert('Ïù¥ÎØ∏ÏßÄÎ•º Î®ºÏ†Ä ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.'); return; }
  try{
    previewLoader.classList.remove('hidden');
    const t0=performance.now();
    const {placements,totalW,totalH}=await buildLayout();
    await renderPreview(previewLarge, placements, totalW, totalH, 2000, PREVIEW_MAX_H);
    await renderPreview(previewSmall, placements, totalW, totalH, 700, 380);
    const blob=await buildBlob(placements,totalW,totalH);
    const mb=(blob.size/1048576).toFixed(2);
    const mp=(totalW*totalH/1e6).toFixed(1);
    infoLine.textContent=`${images.length}Ïû• ¬∑ ${totalW}√ó${totalH} (${mp}MP) ¬∑ ${format.split('/')[1].toUpperCase()} ¬∑ ${mb}MB ¬∑ ${( (performance.now()-t0)/1000 ).toFixed(2)}s`;
    downloadBtn.disabled=false;
    downloadBtn.onclick=()=>{
      const a=document.createElement('a');
      const d=new Date(); const ts=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
      a.download=`merged_${ts}.${format==='image/png'?'png':'jpg'}`;
      a.href=URL.createObjectURL(blob); a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    };
  }catch(err){
    console.error(err); alert('Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
  }finally{
    previewLoader.classList.add('hidden');
  }
});

/* ---------- Init ---------- */
function updateAll(){
  updateStatus(); updateUIByFormat(); updatePadVisibility();
}
updateAll(); renderThumbs(); drawEmptyPreviews();

/* Clipboard paste support */
document.addEventListener('paste',e=>{
  const items=e.clipboardData?.items; if(!items) return;
  for(const it of items){
    if(it.type?.startsWith('image/')){
      const b=it.getAsFile(); const r=new FileReader();
      r.onload=ev=>{ images.push({src:ev.target.result,name:`clipboard_${images.length+1}.png`,rotation:0}); renderThumbs(); };
      r.readAsDataURL(b);
    }
  }
});
</script>
</body>
</html>
