<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ì´ë¯¸ì§€ ì´ì–´ë¶™ì´ê¸° v3.7 (ë°±ê·¸ë¼ìš´ë“œ+ì·¨ì†Œ+UIë³µì›)</title>
<style>
/* ===== ê³µí†µ UI ===== */
body{font-family:"Pretendard","Segoe UI",sans-serif;background:#1e1e1e;color:#f0f0f0;margin:0;padding:20px;}
h1{text-align:center;font-weight:600;margin-bottom:10px;}
.container{max-width:900px;margin:auto;}
.option-box{background:rgba(50,50,50,0.8);backdrop-filter:blur(6px);padding:15px 20px;border-radius:12px;margin-bottom:15px;box-shadow:0 0 10px rgba(0,0,0,0.3);}
button,input,select{background:#333;color:#eee;border:none;border-radius:8px;padding:6px 10px;margin:4px;transition:.15s;}
button:hover{background:#555;cursor:pointer;}
button.active{background:#666;color:#fff;}
small.muted{color:#aaa;}
.thumb-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.thumb{position:relative;width:120px;height:90px;overflow:hidden;border:2px solid #555;border-radius:6px;user-select:none;}
.thumb img{width:100%;height:100%;object-fit:cover;transform-origin:center center;pointer-events:none;}
.thumb .index-label{position:absolute;top:3px;left:4px;background:rgba(0,0,0,.7);padding:1px 4px;font-size:12px;border-radius:3px;}
.thumb .btns{position:absolute;right:2px;bottom:2px;display:flex;gap:2px;}
.thumb button.small{padding:2px 4px;font-size:10px;}
canvas{max-width:100%;border:1px solid #666;border-radius:8px;margin-top:10px;}
#timer{text-align:center;color:#ddd;margin-top:6px;min-height:20px;}
#statusLine{text-align:center;margin:8px 0;color:#ccc;}
#pasteHint{text-align:center;color:#888;font-size:14px;}

/* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ & GIF (400x268 ê³ ì •, ë¹„ìœ¨ ìœ ì§€) ===== */
#loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:999;text-align:center;padding:16px;}
#loadingOverlay img{width:400px;height:268px;object-fit:contain;margin-bottom:12px;image-rendering:auto;}
#loadingOverlay .msg{font-size:18px;}
#loadingOverlay .dots::after{content:'...';animation:dots 1s steps(3,end) infinite;}
@keyframes dots{0%{content:'';}33%{content:'.';}66%{content:'..';}100%{content:'...';}}

/* ===== í† ìŠ¤íŠ¸ ===== */
#toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#333;padding:10px 20px;border-radius:6px;color:#fff;display:none;z-index:1000;}

/* ===== ë„ì›€ë§ íˆ´íŒ ===== */
.help{display:inline-block;margin-left:6px;background:#2a2a2a;border:1px solid #666;border-radius:50%;width:18px;height:18px;line-height:18px;text-align:center;font-size:12px;color:#fff;cursor:help;}
.help:hover{background:#3a3a3a;}
#advanced{display:none;margin-top:10px;}
.toggleBtn{background:#2a2a2a;border:1px solid #666;}

/* ===== ìƒë‹¨ ëª¨ë“œ ë²„íŠ¼ ===== */
#modeBtn{float:right;background:#2a2a2a;border:1px solid #555;}
</style>
</head>
<body>
<div class="container">
  <h1>ì´ë¯¸ì§€ ì´ì–´ë¶™ì´ê¸° v3.7</h1>
  <div id="statusLine">ëª¨ë“œ: ì„¸ë¡œ | í­: ìë™ | í˜•ì‹: PNG | ë©”íƒ€ ìœ ì§€</div>
  <button id="modeBtn">í˜„ì¬: ì„¸ë¡œëª¨ë“œ ğŸ”½</button>

  <!-- â‘  ì—…ë¡œë“œ & ìˆœì„œ -->
  <div class="option-box">
    <h3>â‘  ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ìˆœì„œ ì„¤ì •</h3>
    <input type="file" id="fileInput" multiple accept="image/*"><br />
    <small class="muted">ì¸ë„¤ì¼ â†» íšŒì „ / âŒ ì‚­ì œ / ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥</small><br />
    <div id="pasteHint">ğŸ’¡ Ctrl+Vë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥ (iOS SafariëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)</div>
    <button id="sortName">ì´ë¦„ìˆœ ì •ë ¬</button>
    <button id="sortNameReverse">ì—­ìˆœ ì •ë ¬</button>
    <div id="thumbContainer" class="thumb-list"></div>
  </div>

  <!-- â‘¡ ì˜µì…˜ -->
  <div class="option-box">
    <h3>â‘¡ ì˜µì…˜ ì„¤ì •</h3>

    <div>
      <label>ê°€ë¡œ í¬ê¸° (í­ ê¸°ì¤€):</label>
      <!-- ì´ˆê¸° í™œì„±í™”: ìë™ -->
      <button class="widthBtn active" data-width="auto">ìë™</button>
      <button class="widthBtn" data-width="720">720</button>
      <button class="widthBtn" data-width="1280">1280 (ì¶”ì²œ)</button>
      <button class="widthBtn" data-width="1920">1920 (ì¶”ì²œ)</button>
      <button class="widthBtn" data-width="2560">2560</button>
      <button class="widthBtn" data-width="3840">3840</button>
      <input type="number" id="customWidth" placeholder="ìˆ˜ë™ì…ë ¥(px)" style="width:120px" />
    </div>

    <div>
      <label>ë¹„ìœ¨ ì¡°ì • ë°©ì‹:</label>
      <label><input type="radio" name="scaleMode" value="keep" checked> ë¹„ìœ¨ ìœ ì§€ (í™•ëŒ€/ì¶•ì†Œ)</label>
      <label><input type="radio" name="scaleMode" value="stretch"> í­ ê°•ì œ ë§ì¶¤ (ë¹„ìœ¨ ë¬´ì‹œ)</label>
    </div>

    <div>
      <label>ì´ë¯¸ì§€ ê°„ê²©(px):</label>
      <input type="number" id="gapInput" value="0" min="0" style="width:70px" />
    </div>

    <div>
      <label>ì¶œë ¥ í˜•ì‹:</label>
      <label><input type="radio" name="format" value="image/png" checked> PNG</label>
      <label><input type="radio" name="format" value="image/jpeg"> JPEG</label>
    </div>

    <button id="toggleAdvanced" class="toggleBtn">ê³ ê¸‰ ì˜µì…˜ ë³´ê¸° â–¼</button>
    <div id="advanced">
      <label><input type="checkbox" id="stripMeta"> ë©”íƒ€ë°ì´í„° ì œê±° (EXIF, GPS ë“±)</label>
      <span class="help" title="ë¸Œë¼ìš°ì €ì—ì„œ Canvasë¡œ ì €ì¥í•˜ë©´ ì¼ë°˜ì ìœ¼ë¡œ EXIF/GPSëŠ” ì œê±°ë©ë‹ˆë‹¤. ì´ ì˜µì…˜ì€ ìƒ‰ê³µê°„/íšŒì „ì •ë³´ ë“± ì˜ˆì™¸ë¥¼ ì¶”ê°€ë¡œ ì œê±°í•˜ë ¤ëŠ” ë³´ì•ˆ ëª©ì ì…ë‹ˆë‹¤.">â”</span>
    </div>
  </div>

  <!-- â‘¢ ê²°ê³¼ -->
  <div class="option-box">
    <h3>â‘¢ ê²°ê³¼</h3>
    <button id="mergeBtn">ì´ë¯¸ì§€ í•©ì¹˜ê¸°</button>
    <button id="cancelBtn" disabled>ì·¨ì†Œ</button>
    <button id="downloadBtn" disabled>ë‹¤ìš´ë¡œë“œ</button>
    <div id="timer"></div>
    <canvas id="resultCanvas"></canvas>
    <canvas id="previewCanvas"></canvas>
  </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ (GIF + ë¬¸êµ¬ ë³µì›) -->
<div id="loadingOverlay">
  <img src="loading.gif" alt="loading gif (400x268)"/>
  <div class="msg">ê°€ì€ì´ê°€ ì—´ì‹¬íˆ ë§Œë“¤ê³  ìˆì–´ìš”! âœ¨ <span class="dots"></span></div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast"></div>

<script>
/* ===== ì „ì—­ ìƒíƒœ ===== */
const fileInput = document.getElementById('fileInput');
const thumbContainer = document.getElementById('thumbContainer');
const modeBtn = document.getElementById('modeBtn');
const statusLine = document.getElementById('statusLine');
const mergeBtn = document.getElementById('mergeBtn');
const cancelBtn = document.getElementById('cancelBtn');
const downloadBtn = document.getElementById('downloadBtn');
const timerEl = document.getElementById('timer');
const resultCanvas = document.getElementById('resultCanvas');
const rctx = resultCanvas.getContext('2d');
const previewCanvas = document.getElementById('previewCanvas');
const pctx = previewCanvas.getContext('2d');
const loadingOverlay = document.getElementById('loadingOverlay');
const toast = document.getElementById('toast');
const advBox = document.getElementById('advanced');

let images = [];                 // {src, name, rotation}
let mode = 'vertical';           // 'vertical' | 'horizontal'
let selectedWidth = 'auto';      // 'auto' | number
let selectedFormat = 'image/png';
let stripMeta = false;
let currentWorker = null;        // Web Worker í•¸ë“¤
let isMerging = false;

/* ===== í—¬í¼ ===== */
function showToast(msg){
  toast.textContent = msg; toast.style.display='block';
  setTimeout(()=>toast.style.display='none', 2000);
}
function updateStatus(){
  const w = (selectedWidth === 'auto') ? 'ìë™' : (selectedWidth + 'px');
  const m = (mode === 'vertical') ? 'ì„¸ë¡œ' : 'ê°€ë¡œ';
  const f = (selectedFormat === 'image/png') ? 'PNG' : 'JPEG';
  const meta = stripMeta ? 'ë©”íƒ€ ì œê±°' : 'ë©”íƒ€ ìœ ì§€';
  statusLine.textContent = `ëª¨ë“œ: ${m} | í­: ${w} | í˜•ì‹: ${f} | ${meta}`;
}
function setBusy(b){
  isMerging = b;
  mergeBtn.disabled = b;
  cancelBtn.disabled = !b;
  downloadBtn.disabled = b; // ë³‘í•© ëë‚˜ê¸° ì „ì—” ë¹„í™œì„±
  loadingOverlay.style.display = b ? 'flex' : 'none';
}

/* ===== ëª¨ë“œ ì „í™˜ ===== */
modeBtn.onclick = () => {
  mode = (mode === 'vertical') ? 'horizontal' : 'vertical';
  modeBtn.textContent = (mode === 'vertical') ? 'í˜„ì¬: ì„¸ë¡œëª¨ë“œ ğŸ”½' : 'í˜„ì¬: ê°€ë¡œëª¨ë“œ â–¶ï¸';
  updateStatus();
};

/* ===== ê°€ë¡œí­ ë²„íŠ¼ ===== */
document.querySelectorAll('.widthBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    selectedWidth = (btn.dataset.width === 'auto') ? 'auto' : parseInt(btn.dataset.width);
    document.querySelectorAll('.widthBtn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updateStatus();
  });
});

/* ===== í¬ë§· ì„ íƒ ===== */
document.querySelectorAll('input[name="format"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    selectedFormat = document.querySelector('input[name="format"]:checked').value;
    updateStatus();
  });
});

/* ===== ê³ ê¸‰ ì˜µì…˜ í† ê¸€/ì²´í¬ ===== */
document.getElementById('toggleAdvanced').onclick = ()=>{
  advBox.style.display = (advBox.style.display === 'none' || advBox.style.display === '') ? 'block' : 'none';
};
document.getElementById('stripMeta').onchange = (e)=>{ stripMeta = e.target.checked; updateStatus(); };

/* ===== ì—…ë¡œë“œ (ì´í•© ìš©ëŸ‰ë§Œ ì œí•œ) ===== */
fileInput.addEventListener('change', ()=>{
  const files = Array.from(fileInput.files);
  const totalMB = files.reduce((s,f)=>s+f.size,0)/(1024*1024);
  const MAX_TOTAL = 300;
  if(totalMB > MAX_TOTAL){
    alert(`ì´ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (â‰¤ ${MAX_TOTAL}MB). í˜„ì¬ ${totalMB.toFixed(1)}MB`);
    return;
  }
  images = [];
  files.forEach(file=>{
    const r = new FileReader();
    r.onload = e=>{
      images.push({src:e.target.result,name:file.name,rotation:0});
      renderThumbs();
    };
    r.readAsDataURL(file);
  });
});

/* ===== ì¸ë„¤ì¼ ë Œë”ë§/ì •ë ¬/ë“œë˜ê·¸/íšŒì „/ì‚­ì œ ===== */
function renderThumbs(){
  thumbContainer.innerHTML='';
  images.forEach((imgObj,i)=>{
    const div=document.createElement('div'); div.className='thumb'; div.draggable=true; div.dataset.index=i;
    const img=document.createElement('img'); img.src=imgObj.src; img.style.transform=`rotate(${imgObj.rotation}deg)`;
    const label=document.createElement('div'); label.className='index-label'; label.textContent=i+1;
    const btns=document.createElement('div'); btns.className='btns';
    const rot=document.createElement('button'); rot.textContent='â†»'; rot.className='small';
    rot.onclick=()=>{ imgObj.rotation=(imgObj.rotation+90)%360; renderThumbs(); };
    const del=document.createElement('button'); del.textContent='âŒ'; del.className='small';
    del.onclick=()=>{ images.splice(i,1); renderThumbs(); };
    btns.append(rot,del);
    div.append(img,label,btns);
    thumbContainer.append(div);
    // ë“œë˜ê·¸ ìˆœì„œ ë³€ê²½
    div.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',i));
    div.addEventListener('dragover',e=>e.preventDefault());
    div.addEventListener('drop',e=>{
      e.preventDefault();
      const from=parseInt(e.dataTransfer.getData('text/plain'));
      const to=i;
      if(from!==to){ const t=images.splice(from,1)[0]; images.splice(to,0,t); renderThumbs(); }
    });
  });
}
document.getElementById('sortName').onclick = ()=>{ images.sort((a,b)=>a.name.localeCompare(b.name,'ko')); renderThumbs(); showToast('ì´ë¦„ìˆœ ì •ë ¬ ì™„ë£Œ'); };
document.getElementById('sortNameReverse').onclick = ()=>{ images.sort((a,b)=>b.name.localeCompare(a.name,'ko')); renderThumbs(); showToast('ì—­ìˆœ ì •ë ¬ ì™„ë£Œ'); };

/* ===== í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° (Ctrl+V) ===== */
document.addEventListener('paste', e=>{
  const items = e.clipboardData?.items; if(!items) return;
  const before = images.length;
  for(const item of items){
    if(item.type.startsWith('image/')){
      const blob=item.getAsFile();
      const r=new FileReader();
      r.onload=ev=>{
        images.push({src:ev.target.result,name:'clipboard_'+images.length+'.png',rotation:0});
        renderThumbs();
        if(images.length>before) showToast('í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì¶”ê°€ë¨');
      };
      r.readAsDataURL(blob);
    }
  }
});

/* ===== ë³‘í•© (OffscreenCanvas + Web Worker) ===== */
mergeBtn.addEventListener('click', async ()=>{
  if(images.length===0) return alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.');
  if(isMerging) return;

  // ì…ë ¥ê°’ ìˆ˜ì§‘
  const gap = parseInt(document.getElementById('gapInput').value)||0;
  const custom = parseInt(document.getElementById('customWidth').value);
  const scaleMode = document.querySelector('input[name="scaleMode"]:checked').value; // 'keep' | 'stretch'
  const format = selectedFormat; // 'image/png' | 'image/jpeg'

  setBusy(true);
  timerEl.textContent = 'ì¤€ë¹„ ì¤‘...';

  // ì´ë¯¸ì§€ë¥¼ ë¯¸ë¦¬ ë¡œë“œí•´ì„œ ìµœëŒ€ ë„ˆë¹„ ì‚°ì¶œ
  const bitmaps = []; // ë©”ì¸ ìŠ¤ë ˆë“œì—ì„  ì‹¤ì œ ë¡œë”© ì•ˆí•¨(í­ ê³„ì‚°ë§Œ), ì›Œì»¤ê°€ ì§„ì§œ ë Œë”ë§
  let tempMaxW = 0;
  for(const img of images){
    // í­ ê³„ì‚°ì„ ìœ„í•œ ê°„ë‹¨ ë¡œë”©
    const el = new Image();
    const p = new Promise(res=>{ el.onload=()=>res(el.width); el.src=img.src; });
    const w = await p; tempMaxW = Math.max(tempMaxW, w);
  }
  let canvasWidth = (selectedWidth==='auto') ? tempMaxW : selectedWidth;
  if(custom>0) canvasWidth = custom;

  // ì›Œì»¤ ìƒì„± (Blob URL)
  const workerCode = `
    self.onmessage = async (e) => {
      const {images, mode, scaleMode, gap, canvasWidth, format} = e.data;
      try{
        // ì´ë¯¸ì§€ ë¡œë“œ (ImageBitmap)
        const loaded = [];
        for (let i=0;i<images.length;i++){
          const src = images[i].src;
          const resp = await fetch(src);
          const blob = await resp.blob();
          const bmp = await createImageBitmap(blob);
          loaded.push({bmp, w:bmp.width, h:bmp.height});
          self.postMessage({type:'progress', i:i+1, total:images.length, phase:'load'});
        }

        // ìŠ¤ì¼€ì¼ ê³„ì‚°
        const scaled = [];
        for (let i=0;i<loaded.length;i++){
          let w = loaded[i].w, h = loaded[i].h;
          if (scaleMode==='keep'){
            const s = canvasWidth / w; w = w * s; h = h * s;
          } else if (scaleMode==='stretch'){
            w = canvasWidth; // hëŠ” ê·¸ëŒ€ë¡œ(ìˆ˜ì§ ìŠ¤ì¼€ì¼ ìœ ì§€)
          }
          scaled.push({bmp:loaded[i].bmp, w, h});
        }

        // ìº”ë²„ìŠ¤ í¬ê¸° ê³„ì‚°
        let cw, ch;
        if (mode==='vertical'){
          cw = canvasWidth;
          ch = scaled.reduce((s,v)=>s+v.h,0) + gap*(scaled.length-1);
        } else {
          ch = Math.max(...scaled.map(v=>v.h));
          cw = scaled.reduce((s,v)=>s+v.w,0) + gap*(scaled.length-1);
        }

        const off = new OffscreenCanvas(cw, ch);
        const ctx = off.getContext('2d', { alpha: false, desynchronized: true });
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,cw,ch);

        // ê·¸ë¦¬ê¸°
        let pos = 0;
        for (let i=0;i<scaled.length;i++){
          const s = scaled[i];
          if (mode==='vertical'){
            ctx.drawImage(s.bmp, 0, pos, s.w, s.h);
            pos += s.h + gap;
          } else {
            ctx.drawImage(s.bmp, pos, 0, s.w, s.h);
            pos += s.w + gap;
          }
          self.postMessage({type:'progress', i:i+1, total:scaled.length, phase:'draw'});
        }

        // ê²°ê³¼ Blob
        const blob = await off.convertToBlob({ type: format, quality: 1.0 }); // ë¬´ì†ì‹¤ ì§€í–¥
        self.postMessage({type:'done', blob, width: cw, height: ch}, [blob]);
      } catch(err){
        self.postMessage({type:'error', message: String(err)});
      }
    };
  `;
  const blobURL = URL.createObjectURL(new Blob([workerCode], {type:'application/javascript'}));
  currentWorker = new Worker(blobURL);
  URL.revokeObjectURL(blobURL);

  currentWorker.onmessage = async (ev)=>{
    const data = ev.data;
    if(data.type==='progress'){
      // ë¡œë“œ/ë“œë¡œìš° ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      const phaseTxt = (data.phase==='load') ? 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘' : 'ê·¸ë¦¬ëŠ” ì¤‘';
      timerEl.textContent = `${phaseTxt} ${data.i} / ${data.total}`;
    }
    else if(data.type==='done'){
      // ê²°ê³¼ ìˆ˜ì‹ 
      const { blob, width, height } = data;
      // ë©”ì¸ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
      resultCanvas.width = width; resultCanvas.height = height;
      const bmp = await createImageBitmap(blob);
      rctx.clearRect(0,0,width,height);
      rctx.drawImage(bmp,0,0);

      // ë¯¸ë¦¬ë³´ê¸° ì¶•ì†Œ
      const scale = Math.min(600/width, 300/height, 1);
      previewCanvas.width = Math.max(1, Math.floor(width*scale));
      previewCanvas.height = Math.max(1, Math.floor(height*scale));
      pctx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
      pctx.drawImage(bmp,0,0,previewCanvas.width,previewCanvas.height);

      // ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ (ë©”íƒ€ ì˜µì…˜ ì ìš©)
      downloadBtn.disabled = false;
      const d = new Date();
      const stamp = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
      const name = `merged_${stamp}` + (selectedFormat==='image/png'?'.png':'.jpg');

      downloadBtn.onclick = async ()=>{
        if(stripMeta){
          // ì¶”ê°€ ì¬ì¸ì½”ë”©(ë³´ì•ˆ í™•ì‹ ìš©) â€” í™”ì§ˆ ìœ ì§€(1.0)
          const c2 = document.createElement('canvas'); c2.width = width; c2.height = height;
          const x2 = c2.getContext('2d');
          x2.drawImage(resultCanvas,0,0);
          const blob2 = await new Promise(res=>c2.toBlob(res, selectedFormat, 1.0));
          const url2 = URL.createObjectURL(blob2);
          const a = document.createElement('a'); a.download = name; a.href = url2; a.click();
          URL.revokeObjectURL(url2);
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.download = name; a.href = url; a.click();
          URL.revokeObjectURL(url);
        }
      };

      const elapsedTxt = ''; // ì›Œì»¤ ë‚´ì—ì„œ ì •í™•í•œ ì‹œê°„ ì¸¡ì •ì€ ìƒëµ(ì§„í–‰ë¥ ë¡œ ëŒ€ì²´)
      timerEl.textContent = `ì™„ë£Œ | ${images.length}ì¥ | í­ ${width}px | ${mode==='vertical'?'ì„¸ë¡œ':'ê°€ë¡œ'} | ${selectedFormat.split('/')[1].toUpperCase()}`;
      setBusy(false);
      document.getElementById('resultCanvas').scrollIntoView({behavior:'smooth'});
      currentWorker.terminate(); currentWorker=null;
    }
    else if(data.type==='error'){
      alert('ì˜¤ë¥˜: ' + data.message);
      setBusy(false);
      if(currentWorker){ currentWorker.terminate(); currentWorker=null; }
    }
  };

  currentWorker.postMessage({
    images, mode, scaleMode, gap, canvasWidth, format
  });
});

/* ===== ì·¨ì†Œ(Abort) ===== */
cancelBtn.addEventListener('click', ()=>{
  if(currentWorker){
    currentWorker.terminate();
    currentWorker = null;
  }
  setBusy(false);
  timerEl.textContent = 'ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.';
});

/* ===== ì´ˆê¸° ìƒíƒœ í‘œì‹œ ===== */
updateStatus(); // ëª¨ë“œ/í­/í˜•ì‹/ë©”íƒ€
// 'ìë™' ê°€ë¡œí­ ë²„íŠ¼ì€ ì´ë¯¸ .activeë¡œ í‘œì‹œë¨
</script>
</body>
</html>
